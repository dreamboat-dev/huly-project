name: ${PROJECT_NAME:-huly}

x-defaults: &defaults
  restart: ${RESTART_POLICY:-unless-stopped}
  env_file:
    - "./.env"
  volumes:
    - /etc/timezone:/etc/timezone:ro
    - /etc/localtime:/etc/localtime:ro
  networks:
    - huly-internal-net
  logging:
    driver: ${LOGGING_DRIVER:-json-file}
    options:
      max-size: ${LOGGING_MAX_SIZE:-10m}
      max-file: ${LOGGING_MAX_FILE:-3}

services:
  huly-mongodb:
    image: mongo:${MONGODB_IMAGE_TAG:-7-jammy}
    container_name: ${MONGODB_CONTAINER_NAME:-huly-mongodb}
    hostname: ${MONGODB_HOSTNAME:-huly-mongodb}
    <<: [*defaults]
    healthcheck:
      test: [
        "CMD",
        "mongosh", "--eval", "'(db.runCommand({ ping: 1 }).ok ? 0 : 1)'"
      ]
      interval: ${MONGODB_HEALTHCHECK_INTERVAL:-10s}
      timeout: ${MONGODB_HEALTHCHECK_TIMEOUT:-10s}
      retries: ${MONGODB_HEALTHCHECK_RETRIES:-5}
      start_period: ${MONGODB_HEALTHCHECK_START_PERIOD:-30s}
    volumes:
      - type: volume
        source: main-volume
        target: /data/db
        volume:
          nocopy: true
          subpath: mongodb-data
      - type: volume
        source: main-volume
        target: /data/configdb
        volume:
          nocopy: true
          subpath: mongodb-conf
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USERNAME:-huly}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD:?}
      - PUID=${MONGODB_PUID:-1000}
      - PGID=${MONGODB_PGID:-1000}

  huly-elastic:
    image: elasticsearch:${ELASTIC_IMAGE_TAG:-7.14.2}
    container_name: ${ELASTIC_CONTAINER_NAME:-huly-elastic}
    hostname: ${ELASTIC_HOSTNAME:-huly-elastic}
    <<: [*defaults]
    healthcheck:
      test: [
        "CMD-SHELL",
        "curl --silent http://localhost:9200/_cluster/health | grep --quiet '\"status\":\"green\"'"
      ]
      interval: ${ELASTIC_HEALTHCHECK_INTERVAL:-20s}
      timeout: ${ELASTIC_HEALTHCHECK_TIMEOUT:-10s}
      retries: ${ELASTIC_HEALTHCHECK_RETRIES:-5}
      start_period: ${ELASTIC_HEALTHCHECK_START_PERIOD:-30s}
    volumes:
      - type: volume
        source: main-volume
        target: /usr/share/elasticsearch/data
        volume:
          nocopy: true
          subpath: elastic-data
      - type: volume
        source: main-volume
        target: /usr/share/elasticsearch/logs
        volume:
          nocopy: true
          subpath: elastic-logs
    environment:
      - ELASTICSEARCH_PORT_NUMBER=${ELASTIC_PORT:-9200}
      - discovery.type=${ELASTIC_DISCOVERY_TYPE:-single-node}
    command: |
      /bin/sh -c "./bin/elasticsearch-plugin list | grep --quiet ingest-attachment ||
                  yes | ./bin/elasticsearch-plugin install --silent ingest-attachment;
                  /usr/local/bin/docker-entrypoint.sh eswrapper"

  huly-minio:
    image: "minio/minio:${MINIO_IMAGE_TAG:-latest}"
    container_name: ${MINIO_CONTAINER_NAME:-huly-minio}
    hostname: ${MINIO_HOSTNAME:-huly-minio}
    <<: [*defaults]
    volumes:
      - type: volume
        source: main-volume
        target: /data
        volume:
          nocopy: true
          subpath: minio-data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-huly}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:?}
    command: |
      server /data --address ":9000"
                   --console-address ":9001"

  huly-rekoni:
    image: hardcoreeng/rekoni-service:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${REKONI_CONTAINER_NAME:-huly-rekoni}
    hostname: ${REKONI_HOSTNAME:-huly-rekoni}
    <<: [*defaults]
    environment:
      - SECRET=${HULY_SECRET:?}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-transactor:
    image: hardcoreeng/transactor:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${TRANSACTOR_CONTAINER_NAME:-huly-transactor}
    hostname: ${TRANSACTOR_HOSTNAME:-huly-transactor}
    <<: [*defaults]
    environment:
      - SERVER_PORT=${TRANSACTOR_PORT:-333}
      - SERVER_SECRET=${HULY_SECRET:?}
      - SERVER_CURSOR_MAXTIMEMS=${TRANSACTOR_SERVER_CURSOR_MAXTIMEMS:-30000}
      - ELASTIC_URL=${ELASTIC_URL:-http://${ELASTIC_HOSTNAME}:${ELASTIC_PORT}}
      - ELASTIC_INDEX_NAME=${ELASTIC_INDEX_NAME:-huly_storage_index}
      - MONGO_URL=${MONGODB_URL:-mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOSTNAME}:${MONGODB_PORT}}
      - METRICS_CONSOLE=${TRANSACTOR_METRICS_CONSOLE:-false}
      - METRICS_FILE=${TRANSACTOR_METRICS_FILE:-metrics.txt}
      - STORAGE_CONFIG=${STORAGE_CONFIG:-minio|${MINIO_HOSTNAME}?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}}
      - REKONI_URL=${REKONI_URL:-http://${REKONI_HOSTNAME}:${REKONI_PORT}}
      - FRONT_URL=${FRONT_URL:-http://${FRONT_HOSTNAME}:${FRONT_PORT}}
      - ACCOUNTS_URL=${ACCOUNT_URL:-http://${ACCOUNT_HOSTNAME}:${ACCOUNT_PORT}}
      - LAST_NAME_FIRST=${HULY_CONFIG_LAST_NAME_FIRST:-true}
      - UPLOAD_URL=${TRANSACTOR_UPLOAD_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/files}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-collaborator:
    image: hardcoreeng/collaborator:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${COLLABORATOR_CONTAINER_NAME}
    hostname: ${COLLABORATOR_HOSTNAME}
    <<: [*defaults]
    environment:
      - COLLABORATOR_PORT=${COLLABORATOR_PORT:-3078}
      - SECRET=${HULY_SECRET:?}
      - ACCOUNTS_URL=${ACCOUNT_URL:-http://${ACCOUNT_HOSTNAME}:${ACCOUNT_PORT}}
      - MONGO_URL=${MONGODB_URL:-mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOSTNAME}:${MONGODB_PORT}}
      - STORAGE_CONFIG=${STORAGE_CONFIG:-minio|${MINIO_HOSTNAME}?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-account:
    image: hardcoreeng/account:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${ACCOUNT_CONTAINER_NAME:-huly-account}
    hostname: ${ACCOUNT_HOSTNAME:-huly-account}
    <<: [*defaults]
    environment:
      - SERVER_PORT=${ACCOUNT_PORT:-3000}
      - SERVER_SECRET=${HULY_SECRET:?}
      - MONGO_URL=${MONGODB_URL:-mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOSTNAME}:${MONGODB_PORT}}
      - TRANSACTOR_URL=${TRANSACTOR_URL:-ws://${TRANSACTOR_HOSTNAME}:${TRANSACTOR_PORT};${WS_SCHEME}://${SERVER_ADDRESS}/_transactor}
      - STORAGE_CONFIG=${STORAGE_CONFIG:-minio|${MINIO_HOSTNAME}?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}}
      - FRONT_URL=${FRONT_URL:-http://${FRONT_HOSTNAME}:${FRONT_PORT}}
      - MODEL_ENABLED=${ACCOUNT_MODEL_ENABLED:-*}
      - ACCOUNT_PORT=${ACCOUNT_PORT:-3000}
      - ACCOUNTS_URL=${ACCOUNT_URL:-http://${ACCOUNT_HOSTNAME}:${ACCOUNT_PORT}}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-workspace:
    image: hardcoreeng/workspace:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${WORKSPACE_CONTAINER_NAME:-huly-workspace}
    hostname: ${WORKSPACE_HOSTNAME:-huly-workspace}
    <<: [*defaults]
    environment:
      - SERVER_SECRET=${HULY_SECRET:?}
      - MONGO_URL=${MONGODB_URL:-mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOSTNAME}:${MONGODB_PORT}}
      - TRANSACTOR_URL=${TRANSACTOR_URL:-ws://${TRANSACTOR_HOSTNAME}:${TRANSACTOR_PORT};${WS_SCHEME}://${SERVER_ADDRESS}/_transactor}
      - STORAGE_CONFIG=${STORAGE_CONFIG:-minio|${MINIO_HOSTNAME}?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}}
      - MODEL_ENABLED=${WORKSPACE_MODEL_ENABLED:-*}
      - ACCOUNTS_URL=${ACCOUNT_URL:-http://${ACCOUNT_HOSTNAME}:${ACCOUNT_PORT}}
      - NOTIFY_INBOX_ONLY=${HULY_CONFIG_NOTIFY_INBOX_ONLY:-true}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-front:
    image: hardcoreeng/front:${HULY_IMAGE_TAG:-v0.6.313}
    container_name: ${FRONT_CONTAINER_NAME:-huly-front}
    hostname: ${FRONT_HOSTNAME:-huly-front}
    <<: [*defaults]
    environment:
      - SERVER_PORT=${FRONT_PORT:-8080}
      - SERVER_SECRET=${HULY_SECRET:?}
      - ACCOUNTS_URL=${PUBLIC_ACCOUNTS_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_accounts}
      - REKONI_URL=${PUBLIC_REKONI_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_rekoni}
      - CALENDAR_URL=${PUBLIC_CALENDAR_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_calendar}
      - GMAIL_URL=${PUBLIC_GMAIL_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_gmail}
      - TELEGRAM_URL=${PUBLIC_TELEGRAM_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_telegram}
      - COLLABORATOR_URL=${PUBLIC_COLLABORATOR_URL:-${HTTP_SCHEME}://${SERVER_ADDRESS}/_collaborator}
      - UPLOAD_URL=${FRONT_UPLOAD_URL:-/files}
      - ELASTIC_URL=${ELASTIC_URL:-http://${ELASTIC_HOSTNAME}:${ELASTIC_PORT}}
      - STORAGE_CONFIG=${STORAGE_CONFIG:-minio|${MINIO_HOSTNAME}?accessKey=${MINIO_ROOT_USER}&secretKey=${MINIO_ROOT_PASSWORD}}
      - MONGO_URL=${MONGODB_URL:-mongodb://${MONGODB_USERNAME}:${MONGODB_PASSWORD}@${MONGODB_HOSTNAME}:${MONGODB_PORT}}
      - TITLE=${HULY_CONFIG_TITLE:-Huly Self Host}
      - DEFAULT_LANGUAGE=${HULY_CONFIG_DEFAULT_LANGUAGE:-en}
      - LAST_NAME_FIRST=${HULY_CONFIG_LAST_NAME_FIRST:-true}
    networks:
      - huly-internal-net
      - huly-public-net

  huly-nginx:
    image: nginx:${NGINX_IMAGE_TAG:-1.21.3}
    container_name: ${NGINX_CONTAINER_NAME:-huly-nginx}
    hostname: ${NGINX_HOSTNAME:-huly-nginx}
    <<: [*defaults]
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost" ]
      interval: ${NGINX_HEALTHCHECK_INTERVAL:-30s}
      timeout: ${NGINX_HEALTHCHECK_TIMEOUT:-5s}
      retries: ${NGINX_HEALTHCHECK_RETRIES:-3}
      start_period: ${NGINX_HEALTHCHECK_START_PERIOD:-10s}
    volumes:
      - type: bind
        source: ./nginx.conf
        target: /etc/nginx/conf.d/default.conf
        read_only: true
    ports:
      - ${NGINX_PORT:-80}:80
    networks:
      - huly-internal-net
      - huly-public-net

networks:
  huly-public-net:
    name: ${PUBLIC_NET:-huly-public-net}
    driver: bridge
  huly-internal-net:
    name: ${INTERNAL_NET:-huly-internal-net}
    driver: bridge

volumes:
  main-volume:
    name: ${PROJECT_NAME:-huly}